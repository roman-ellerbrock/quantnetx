<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantNetX - Bitcoin Risk Metric</title>
    <link rel="icon" type="image/png" href="assets/quantnetx_minilogo.png">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-title">
                <img src="assets/quantnetx_minilogo.png" alt="QuantNetX" class="minilogo">
                <h1>QuantNetX</h1>
            </div>
            <p class="subtitle">Bitcoin Risk Metric - Logarithmic Regression Model</p>
        </header>

        <nav class="nav-bar">
            <a href="market_pairs.html" class="nav-link">Market Pairs</a>
            <a href="bitcoin_risk.html" class="nav-link active">Bitcoin Risk Metric</a>
            <a href="index.html" class="nav-link">Options Analysis</a>
        </nav>

        <div class="info-box" id="methodInfo">
            <strong>Method:</strong> This risk metric uses logarithmic polynomial regression to model Bitcoin price growth.
            The model assumes polylogarithmic growth: log(P(t)) = a·log(t-t₀) + b, where t₀ = 1.2625632×10⁹ (Unix time).
            The colored bands represent standard deviations in log space, indicating overvaluation (above) and undervaluation (below) regions.
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="scaleSelect">Price Scale</label>
                <select id="scaleSelect">
                    <option value="log">Logarithmic</option>
                    <option value="linear">Linear</option>
                </select>
            </div>
            <div class="control-group">
                <button id="refreshBtn">Refresh Data</button>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="stats" class="stats-grid" style="display: none;"></div>

        <div id="loading" class="loading">Loading data...</div>

    </div>

    <div class="chart-container" id="chartContainer" style="display: none; max-width: none; width: 95vw; margin-left: auto; margin-right: auto;">
        <div id="riskChart" style="width: 100%; height: 700px;"></div>
    </div>

    <div class="chart-container" id="normalizedRiskChartContainer" style="display: none; max-width: none; width: 95vw; margin-left: auto; margin-right: auto;">
        <div id="normalizedRiskChart" style="width: 100%; height: 700px;"></div>
    </div>

    <script>
        let riskData = null;
        let probabilitySurfaceData = null;

        // ============================================================================
        // Utility Functions
        // ============================================================================

        function formatNumber(num, decimals = 2) {
            if (!num || num === '') return '-';
            const n = parseFloat(num);
            if (isNaN(n)) return '-';
            return n.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function formatDate(unixTime) {
            const date = new Date(unixTime * 1000);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // ============================================================================
        // Data Loading
        // ============================================================================

        async function loadRiskData() {
            try {
                const response = await fetch('../data/bitcoin_risk_data.json');
                if (!response.ok) {
                    throw new Error('Failed to load risk data');
                }
                riskData = await response.json();
                return riskData;
            } catch (error) {
                showError('Error loading risk data: ' + error.message);
                return null;
            }
        }

        async function loadProbabilitySurface() {
            try {
                const response = await fetch('../data/probability_surface.json');
                if (!response.ok) {
                    console.warn('Probability surface data not available');
                    return;
                }
                probabilitySurfaceData = await response.json();
            } catch (error) {
                console.warn('Could not load probability surface:', error);
            }
        }

        // Calculate risk metric for a given price and time
        function calculateRiskMetric(price, time, data) {
            // Find the closest time index
            const times = data.data.times;
            const fitted_undervalued = data.data.fitted_undervalued;
            const fitted_extreme_over = data.data.fitted_extreme_overvalued;

            let closestIndex = 0;
            let minDiff = Math.abs(times[0] - time);

            for (let i = 1; i < times.length; i++) {
                const diff = Math.abs(times[i] - time);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestIndex = i;
                }
            }

            const undervalued = fitted_undervalued[closestIndex];
            const overvalued = fitted_extreme_over[closestIndex];

            // Normalize: 0 = extreme undervalued, 1 = extreme overvalued
            const risk = (price - undervalued) / (overvalued - undervalued);
            return Math.max(0, Math.min(1, risk)); // Clamp between 0 and 1
        }

        // ============================================================================
        // Statistics Display
        // ============================================================================

        function updateStats(data) {
            const statsDiv = document.getElementById('stats');
            const params = data.parameters;
            const current = data.current;

            // Determine risk level and color based on normalized risk
            let riskLevel = 'Neutral';
            let riskColor = '#ffc107';
            const risk_norm = current.risk_metric_normalized;
            const risk_sigma = current.risk_metric_sigma;

            if (risk_norm > 1.5) {
                riskLevel = 'Extreme Overvaluation';
                riskColor = '#b71c1c';
            } else if (risk_norm > 1.2) {
                riskLevel = 'Highly Overvalued';
                riskColor = '#f44336';
            } else if (risk_norm > 0.8) {
                riskLevel = 'Overvalued';
                riskColor = '#ff9800';
            } else if (risk_norm > 0.5) {
                riskLevel = 'Slightly Overvalued';
                riskColor = '#ffc107';
            } else if (risk_norm < -0.5) {
                riskLevel = 'Extreme Undervaluation';
                riskColor = '#1b5e20';
            } else if (risk_norm < -0.2) {
                riskLevel = 'Highly Undervalued';
                riskColor = '#2e7d32';
            } else if (risk_norm < 0.2) {
                riskLevel = 'Undervalued';
                riskColor = '#4caf50';
            } else if (risk_norm < 0.5) {
                riskLevel = 'Slightly Undervalued';
                riskColor = '#8bc34a';
            }

            const html = `
                <div class="stat-card">
                    <div class="stat-label">Current Price</div>
                    <div class="stat-value">$${formatNumber(current.price, 2)}</div>
                </div>
                <div class="stat-card" style="border-left: 3px solid ${riskColor};">
                    <div class="stat-label">Risk Metric</div>
                    <div class="stat-value">${risk_norm.toFixed(2)}</div>
                </div>
                <div class="stat-card" style="border-left: 3px solid ${riskColor};">
                    <div class="stat-label">Valuation</div>
                    <div class="stat-value" style="color: ${riskColor};">${riskLevel}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mean Price</div>
                    <div class="stat-value">$${formatNumber(current.fitted_mean, 2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Overvalued Price</div>
                    <div class="stat-value">$${formatNumber(current.fitted_overvalued, 2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Undervalued Price</div>
                    <div class="stat-value">$${formatNumber(current.fitted_undervalued, 2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Extreme Overvalued</div>
                    <div class="stat-value">$${formatNumber(current.fitted_extreme_overvalued, 2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Extreme Undervalued</div>
                    <div class="stat-value">$${formatNumber(current.fitted_extreme_undervalued, 2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Risk (σ)</div>
                    <div class="stat-value">${risk_sigma.toFixed(2)}σ</div>
                </div>
            `;

            statsDiv.innerHTML = html;
            statsDiv.style.display = 'grid';
        }

        // ============================================================================
        // Plotting Functions
        // ============================================================================

        async function plotRiskMetric(data) {
            const scaleType = document.getElementById('scaleSelect').value;
            const times = data.data.times;
            const prices = data.data.prices;
            const fitted_mean = data.data.fitted_mean;
            const fitted_overvalued = data.data.fitted_overvalued;
            const fitted_undervalued = data.data.fitted_undervalued;
            const fitted_extreme_over = data.data.fitted_extreme_overvalued;
            const fitted_extreme_under = data.data.fitted_extreme_undervalued;
            const risk_normalized = data.data.risk_normalized;

            // Convert unix times to dates
            const dates = times.map(t => new Date(t * 1000));

            const traces = [];

            // Add probability density heatmap if available
            if (probabilitySurfaceData && probabilitySurfaceData.surfaces && probabilitySurfaceData.surfaces.BTC) {
                const surfaceData = probabilitySurfaceData.surfaces.BTC.combined_surface;
                const timeUnix = surfaceData.grid.time_unix;
                const surfacePrices = surfaceData.grid.prices;
                const probabilities = surfaceData.grid.probabilities;

                // Convert Unix timestamps to Date objects
                const dateObjects = timeUnix.map(ts => new Date(ts * 1000));

                // Normalize probabilities: for each time (column), scale by sqrt of max at that time
                const numPrices = probabilities.length;
                const numTimes = probabilities[0].length;

                // Find max for each time slice
                const maxByTime = [];
                for (let t = 0; t < numTimes; t++) {
                    let maxVal = 0;
                    for (let p = 0; p < numPrices; p++) {
                        if (probabilities[p][t] > maxVal) {
                            maxVal = probabilities[p][t];
                        }
                    }
                    maxByTime.push(maxVal);
                }

                // Normalize and convert to percentage
                const probabilitiesPercent = probabilities.map(row =>
                    row.map((val, t) => maxByTime[t] > 0 ? (val / Math.pow(maxByTime[t], 0.75)) * 100 : 0)
                );

                // Custom colorscale: blue -> cyan -> yellow -> red with transparency for low values (ggplot2 style)
                const customColorscale = [
                    [0, 'rgba(0, 0, 255, 0)'],        // Transparent blue
                    [0.15, 'rgba(0, 0, 255, 0.2)'],   // Low opacity blue
                    [0.3, 'rgba(0, 127, 255, 0.5)'],  // Medium opacity cyan-blue
                    [0.5, 'rgba(0, 255, 255, 0.8)'],  // Higher opacity cyan
                    [0.7, 'rgba(255, 255, 0, 0.8)'],    // Full opacity yellow
                    [0.85, 'rgba(255, 127, 0, 0.8)'],   // Full opacity orange
                    [1, 'rgba(255, 0, 0, 0.8)']         // Full opacity red
                ];

                // Add heatmap trace (will be rendered behind other traces)
                traces.push({
                    z: probabilitiesPercent,
                    x: dateObjects,
                    y: surfacePrices,
                    type: 'heatmap',
                    colorscale: customColorscale,
                    showscale: false,  // Don't show colorbar for density
                    hovertemplate: 'Date: %{x|%b %d, %Y}<br>Price: $%{y:,.0f}<br>Scaled Prob Density: %{z:.3f}%<extra></extra>',
                    name: 'Probability Density'
                });

                // Load expected prices and add trace BEFORE risk bands
                try {
                    const response = await fetch('../data/implied_probabilities.json');
                    if (response.ok) {
                        const probData = await response.json();
                        const currencyData = probData.currencies.BTC;
                        const expectedPrices = [];

                        // Extract expected prices for each expiry
                        for (const expiryKey in currencyData) {
                            const expiryData = currencyData[expiryKey];
                            const expiryTimestamp = expiryData.expiration_timestamp / 1000;
                            const expectedPrice = expiryData.call_statistics?.expected_price;

                            if (expectedPrice && expiryTimestamp) {
                                expectedPrices.push({
                                    time: expiryTimestamp,
                                    date: new Date(expiryTimestamp * 1000),
                                    price: expectedPrice
                                });
                            }
                        }

                        // Sort by time
                        expectedPrices.sort((a, b) => a.time - b.time);

                        if (expectedPrices.length > 0) {
                            // Calculate risk values for expected prices
                            const expectedRisk = expectedPrices.map(ep =>
                                calculateRiskMetric(ep.price, ep.time, data)
                            );

                            // Add expected price trace (appears in front of heatmap)
                            traces.push({
                                x: expectedPrices.map(p => p.date),
                                y: expectedPrices.map(p => p.price),
                                type: 'scatter',
                                mode: 'lines+markers',
                                name: 'Expected Price (Options)',
                                line: {
                                    width: 2,
                                    dash: 'dash'
                                },
                                marker: {
                                    size: 6,
                                    color: expectedRisk,
                                    colorscale: [
                                        [0, '#0d47a1'],
                                        [0.25, '#2196f3'],
                                        [0.5, '#ffc107'],
                                        [0.75, '#ff9800'],
                                        [1, '#b71c1c']
                                    ],
                                    cmin: 0,
                                    cmax: 1,
                                    showscale: false,
                                    line: { width: 1, color: '#ffffff' }
                                },
                                hovertemplate: 'Date: %{x|%b %d, %Y}<br>Expected: $%{y:,.0f}<extra></extra>'
                            });
                        }
                    }
                } catch (err) {
                    console.warn('Could not load expected prices:', err);
                }
            }

            // Extreme overvalued boundary (dark red - top of rainbow)
            traces.push({
                x: dates,
                y: fitted_extreme_over,
                name: 'Extreme Overvalued',
                type: 'scatter',
                mode: 'lines',
                line: { color: 'rgba(183, 28, 28, 0.4)', width: 1.5 },
//                fill: 'tonexty',
//                fillcolor: 'rgba(183, 28, 28, 0.1)'
            });

            // Overvalued fitted regression line (red)
            traces.push({
                x: dates,
                y: fitted_overvalued,
                name: 'Overvalued Model',
                type: 'scatter',
                mode: 'lines',
                line: { color: 'rgba(244, 67, 54, 0.4)', width: 1.5 },
                fill: 'tonexty',
                fillcolor: 'rgba(244, 67, 54, 0.05)'
            });

            // Mean fitted regression line (yellow - middle of rainbow)
            traces.push({
                x: dates,
                y: fitted_mean,
                name: 'Mean Price Model',
                type: 'scatter',
                mode: 'lines',
                line: { color: 'rgba(255, 193, 7, 0.5)', width: 2 },
                fill: 'tonexty',
                fillcolor: 'rgba(255, 193, 7, 0.05)'
            });

            // Undervalued fitted regression line (medium blue)
            traces.push({
                x: dates,
                y: fitted_undervalued,
                name: 'Undervalued Model',
                type: 'scatter',
                mode: 'lines',
                line: { color: 'rgba(33, 150, 243, 0.4)', width: 1.5 },
                fill: 'tonexty',
                fillcolor: 'rgba(33, 150, 243, 0.05)'
            });

            // Extreme undervalued boundary (dark blue - bottom of rainbow)
            traces.push({
                x: dates,
                y: fitted_extreme_under,
                name: 'Extreme Undervalued',
                type: 'scatter',
                mode: 'lines',
                line: { color: 'rgba(13, 71, 161, 0.4)', width: 1.5 },
                fill: 'tonexty',
                fillcolor: 'rgba(13, 71, 161, 0.03)'
            });

            // Actual Bitcoin price - colored by risk metric
            // Filter out null values for the price trace
            const validIndices = [];
            const validDates = [];
            const validPrices = [];
            const validRisk = [];

            for (let i = 0; i < prices.length; i++) {
                if (prices[i] !== null && risk_normalized[i] !== null) {
                    validIndices.push(i);
                    validDates.push(dates[i]);
                    validPrices.push(prices[i]);
                    validRisk.push(risk_normalized[i]);
                }
            }

            traces.push({
                x: validDates,
                y: validPrices,
                name: 'Bitcoin Price',
                type: 'scatter',
                mode: 'markers+lines',
                marker: {
                    size: 4,
                    color: validRisk,
                    colorscale: [
                        [0, '#0d47a1'],     // Deep blue - low risk (undervalued)
                        [0.25, '#2196f3'],  // Blue
                        [0.5, '#ffc107'],   // Yellow - medium risk
                        [0.75, '#ff9800'],  // Orange
                        [1, '#b71c1c']      // Deep red - high risk (overvalued)
                    ],
                    colorbar: {
                        title: 'Risk',
                        titleside: 'right',
                        tickmode: 'linear',
                        tick0: 0,
                        dtick: 0.25,
                        thickness: 15,
                        len: 0.7,
                        x: 1.02,
                        bgcolor: 'rgba(0, 0, 0, 0.5)',
                        bordercolor: 'rgba(255, 255, 255, 0.2)',
                        borderwidth: 1,
                        tickfont: { color: '#e4e4e4' },
                        titlefont: { color: '#e4e4e4' }
                    },
                    cmin: 0,
                    cmax: 1,
                    showscale: true
                },
                line: {
                    width: 2,
                    color: 'rgba(255, 255, 255, 0.3)'
                }
            });

            const layout = {
                title: {
                    text: 'Bitcoin Price with Logarithmic Regression Risk Bands',
                    font: { color: '#e4e4e4', size: 20 }
                },
                xaxis: {
                    title: 'Date',
                    color: '#a0a0a0',
                    gridcolor: 'rgba(255, 255, 255, 0.1)'
                },
                yaxis: {
                    title: 'Price (USD)',
                    color: '#a0a0a0',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    type: scaleType,
                    tickformat: scaleType === 'log' ? '.0f' : '$,.0f'
                },
                plot_bgcolor: 'rgba(0, 0, 0, 0.2)',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                font: { color: '#e4e4e4' },
                hovermode: 'x unified',
                showlegend: true,
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: -0.2,
                    yanchor: 'top',
                    bgcolor: 'rgba(0, 0, 0, 0.5)',
                    bordercolor: 'rgba(255, 255, 255, 0.2)',
                    borderwidth: 1
                },
                margin: {
                    b: 120
                }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            };

            // WICHTIG: Container ZUERST sichtbar machen
            document.getElementById('chartContainer').style.display = 'block';

            // Dann Chart erstellen
            Plotly.newPlot('riskChart', traces, layout, config);

            // Und Resize erzwingen
            setTimeout(() => {
                Plotly.Plots.resize('riskChart');
            }, 100);
        }

        function plotNormalizedRisk(data) {
            const times = data.data.times;
            const risk_normalized = data.data.risk_normalized;
            const prices = data.data.prices;
            const fitted_undervalued = data.data.fitted_undervalued;
            const fitted_top = data.data.fitted_top;

            const dates = times.map(t => new Date(t * 1000));

            // Calculate boundary risk traces (undervalued=0, top=1)
            const undervalued_risk = [];
            const mean_risk = [];
            const top_risk = [];
            for (let i = 0; i < prices.length; i++) {
                undervalued_risk.push(0.0);  // Undervalued = 0
                mean_risk.push(0.5);  // Mean = 0.5
                top_risk.push(1.0);  // Top = 1
            }

            const traces = [];

            // Undervalued boundary line (0) - dark blue
            traces.push({
                x: dates,
                y: undervalued_risk,
                type: 'scatter',
                mode: 'lines',
                name: 'Undervalued (0)',
                line: { color: 'rgba(13, 71, 161, 0.6)', width: 1.5 }
            });

            // Top boundary line (1) - dark red
            traces.push({
                x: dates,
                y: top_risk,
                type: 'scatter',
                mode: 'lines',
                name: 'Top (1)',
                line: { color: 'rgba(183, 28, 28, 0.6)', width: 1.5 }
            });

            // Mean line (0.5) - yellow
            traces.push({
                x: dates,
                y: mean_risk,
                type: 'scatter',
                mode: 'lines',
                name: 'Mean (0.5)',
                line: { color: 'rgba(255, 193, 7, 0.5)', width: 1.5 }
            });

            // Filter out null values for the risk trace and color it
            const validDates = [];
            const validRisk = [];

            for (let i = 0; i < risk_normalized.length; i++) {
                if (risk_normalized[i] !== null) {
                    validDates.push(dates[i]);
                    validRisk.push(risk_normalized[i]);
                }
            }

            // Normalized risk line - colored by risk value
            traces.push({
                x: validDates,
                y: validRisk,
                type: 'scatter',
                mode: 'markers+lines',
                name: 'Risk Metric',
                marker: {
                    size: 4,
                    color: validRisk,
                    colorscale: [
                        [0, '#0d47a1'],     // Deep blue - low risk (undervalued)
                        [0.25, '#2196f3'],  // Blue
                        [0.5, '#ffc107'],   // Yellow - medium risk
                        [0.75, '#ff9800'],  // Orange
                        [1, '#b71c1c']      // Deep red - high risk (overvalued)
                    ],
                    cmin: 0,
                    cmax: 1,
                    showscale: false  // Don't show colorbar since it's in the first chart
                },
                line: {
                    width: 2,
                    color: 'rgba(255, 255, 255, 0.3)'
                }
            });

            const layout = {
                title: {
                    text: 'Bitcoin Risk Metric Over Time (Extreme Boundaries)',
                    font: { color: '#e4e4e4', size: 20 }
                },
                xaxis: {
                    title: 'Date',
                    color: '#a0a0a0',
                    gridcolor: 'rgba(255, 255, 255, 0.1)'
                },
                yaxis: {
                    title: 'Risk Metric (0 = Extreme Undervalued, 1 = Extreme Overvalued)',
                    color: '#a0a0a0',
                    gridcolor: 'rgba(255, 255, 255, 0.1)'
                },
                plot_bgcolor: 'rgba(1, 0, 0, 0.2)',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                font: { color: '#e4e4e4' },
                hovermode: 'x unified',
                showlegend: true,
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: -0.2,
                    yanchor: 'top',
                    bgcolor: 'rgba(0, 0, 0, 0.5)',
                    bordercolor: 'rgba(255, 255, 255, 0.2)',
                    borderwidth: 1
                },
                margin: {
                    b: 100
                }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            };

            // WICHTIG: Container ZUERST sichtbar machen
            document.getElementById('normalizedRiskChartContainer').style.display = 'block';

            // Dann Chart erstellen
            Plotly.newPlot('normalizedRiskChart', traces, layout, config);

            // Und Resize erzwingen
            setTimeout(() => {
                Plotly.Plots.resize('normalizedRiskChart');
            }, 100);
        }

        // ============================================================================
        // Event Handlers
        // ============================================================================

        document.getElementById('scaleSelect').addEventListener('change', () => {
            if (riskData) {
                plotRiskMetric(riskData);
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('normalizedRiskChartContainer').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
            hideError();

            await initialize();
        });

        // ============================================================================
        // Initialization
        // ============================================================================

        async function initialize() {
            // Load probability surface data (don't block on errors)
            await loadProbabilitySurface().catch(err => {
                console.warn('Failed to load probability surface:', err);
            });

            const data = await loadRiskData();

            if (data) {
                updateStats(data);
                plotRiskMetric(data);
                plotNormalizedRisk(data);
            }

            document.getElementById('loading').style.display = 'none';
        }

        // Start the application
        initialize();

        // Window Resize Handler - resize charts when window is resized
        window.addEventListener('resize', () => {
            if (document.getElementById('chartContainer').style.display !== 'none') {
                Plotly.Plots.resize('riskChart');
            }
            if (document.getElementById('normalizedRiskChartContainer').style.display !== 'none') {
                Plotly.Plots.resize('normalizedRiskChart');
            }
        });
    </script>
</body>
</html>
